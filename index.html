<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QRコードリーダー（結果維持）</title>
  <style>
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 1px solid #ccc;
      min-height: 200px;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #decoded-data {
        font-weight: bold;
        color: darkgreen;
        word-break: break-all;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>QRコードを読み取る</h1>

<div class="controls">
    <button id="start-button">QRコード読み取り開始</button>
    <button id="cancel-button" disabled>キャンセルして停止</button>
</div>

<div id="reader" style="width: 300px; margin: 20px auto;"></div>

<p id="result">QRコードの内容がここに表示されます</p>
<p>読み取り結果:</p>
<p id="decoded-data">[読み取られていません]</p>


<script>
    const resultElement = document.getElementById("result");
    const decodedDataElement = document.getElementById("decoded-data");
    const startButton = document.getElementById("start-button");
    const cancelButton = document.getElementById("cancel-button");

    let html5QrCode = null;

    // ⭐ 状態リセット専用の関数 (ボタンとカメラのみ)
    function resetButtons() {
        startButton.disabled = false;
        cancelButton.disabled = true;
        document.getElementById("reader").innerHTML = "";
        html5QrCode = new Html5Qrcode("reader"); 
    }

    // 読み取り成功時の処理
    function onScanSuccess(decodedText, decodedResult) {
        html5QrCode.stop().then(() => {
            // ⭐ 状態メッセージを設定
            resultElement.innerText = `読み取り成功！カメラを停止しました。`;
            // ⭐ データは新しい要素に表示 (ここが結果を維持するポイント)
            decodedDataElement.innerText = decodedText; 
            
            console.log("QR Code scanning stopped. Result retained.");
            
            // ⭐ 結果は保持したまま、ボタン状態だけリセット
            resetButtons(); 
        }).catch(err => {
            resultElement.innerText = `読み取り成功、しかし停止エラー: ${err}`;
            resetButtons();
        });
    }

    // 読み取り失敗時やエラー時の処理
    function onScanFailure(error) {
      // (実装なし)
    }

    // ************ 初期化 ************
    if (typeof Html5Qrcode !== 'undefined') {
        html5QrCode = new Html5Qrcode("reader"); 
    } else {
        resultElement.innerText = "ライブラリの読み込みに失敗しました。";
        startButton.disabled = true;
    }

    // ************ イベントリスナー ************

    // 読み取り開始ボタンの処理
    startButton.addEventListener('click', () => {
        startButton.disabled = true;
        cancelButton.disabled = false;
        resultElement.innerText = "カメラ起動中... QRコードをかざしてください。";
        // ⭐ データエリアをスキャン中の表示にリセット
        decodedDataElement.innerText = "[スキャン中...]";

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            resultElement.innerText = `カメラ起動エラー: ${err}`;
            decodedDataElement.innerText = "[エラーにより停止]"; // データエリアも更新
            resetButtons();
            console.error(err);
        });
    });

    // キャンセルボタン（カメラ停止）の処理
    cancelButton.addEventListener('click', () => {
        if (html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                resultElement.innerText = "カメラが停止され、結果がリセットされました。";
                
                // ⭐ キャンセル時はデータも初期化
                decodedDataElement.innerText = "[読み取られていません]";
                resetButtons();
            }).catch(err => {
                resultElement.innerText = `カメラ停止エラー: ${err}`;
                decodedDataElement.innerText = "[エラーにより停止]";
                resetButtons();
            });
        } else {
            // スキャン中でない場合は両方をリセット
            resultElement.innerText = "QRコードの内容がここに表示されます";
            decodedDataElement.innerText = "[読み取られていません]";
            resetButtons();
        }
    });

    // ページロード時、最初の状態を設定
    resetButtons(); 

</script>
</body>
</html>
