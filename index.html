<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QRコード生成・回転・画像結合・保存</title>
    <style>
        #qrcode-container {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
        }

        #qrcode-container canvas { /* img は qrcode.js が canvas にフォールバックするまで不要 */
            transform: rotate(45deg); 
            transform-origin: center center;
            margin: 50px; 
            transition: transform 0.3s ease-in-out; 
            max-width: calc(100% - 100px); 
            height: auto;
            border: 1px solid #ddd; /* QRコードの境界を明確に */
        }

        .input-group {
            margin-bottom: 20px;
        }

        #download-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }
        #download-button:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }

        /* 結合後の画像プレビュー（オプション） */
        #combined-image-preview {
            margin-top: 30px;
            text-align: center;
        }
        #combined-image-preview img {
            max-width: 100%;
            height: auto;
            border: 2px dashed #007bff;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <h1>文字列をQRコードに変換・結合・回転・保存</h1>

    <div class="input-group">
        <label for="text-input">変換したい文字列を入力してください:</label><br>
        <input type="text" id="text-input" value="Hello, Combined QR!" style="width: 80%; padding: 8px;">
    </div>
    
    <button onclick="generateAndCombineQr()">QRコードを生成・結合・保存</button>

    <div id="qrcode-container">
        <p>ここに生成されたQRコードが表示されます。</p>
    </div>

    <div id="combined-image-preview" class="hidden">
        <h2>結合後の画像プレビュー</h2>
        <img id="combined-image" alt="結合後のQRコードと背景画像" style="display: none;">
        <p id="preview-message"></p>
    </div>

    <button id="download-button" class="hidden">結合済み画像を保存 (PNG)</button>

    <script>
        const container = document.getElementById('qrcode-container');
        const inputTextElement = document.getElementById('text-input');
        const downloadButton = document.getElementById('download-button');
        const combinedImagePreview = document.getElementById('combined-image-preview');
        const combinedImageElement = document.getElementById('combined-image');
        const previewMessage = document.getElementById('preview-message');

        const IMAGE_BACKGROUND_PATH = "image/image4.png"; // ⭐ 背景画像のパス

        // ⭐ 既存画像を読み込むヘルパー関数 (Promiseを返す)
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`画像の読み込みに失敗しました: ${src}`));
                img.src = src;
            });
        }

        async function generateAndCombineQr() {
            const inputText = inputTextElement.value;

            container.innerHTML = ''; // QRコード表示エリアをクリア
            combinedImagePreview.classList.add('hidden'); // プレビューも非表示
            combinedImageElement.style.display = 'none'; // プレビュー画像も非表示
            downloadButton.classList.add('hidden'); // ダウンロードボタンも非表示
            
            if (!inputText) {
                container.innerHTML = '<p>文字列を入力してください。</p>';
                return;
            }

            try {
                previewMessage.innerText = "背景画像を読み込み中...";
                combinedImagePreview.classList.remove('hidden');

                // 1. 背景画像を読み込む
                const backgroundImage = await loadImage(IMAGE_BACKGROUND_PATH);
                previewMessage.innerText = "QRコードを生成中...";

                // 2. qrcode.jsでQRコードを一時的に生成
                // qrcode.jsは直接canvas要素を返すのではなく、指定したDOM要素にcanvasを追加します。
                // そのため、一時的なdiv要素を作成し、そこにQRコードを生成します。
                const tempQrContainer = document.createElement('div');
                new QRCode(tempQrContainer, {
                    text: inputText,
                    width: 200,      // QRコードの幅
                    height: 200,     // QRコードの高さ
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                const qrCanvas = tempQrContainer.querySelector('canvas');
                if (!qrCanvas) {
                    throw new Error("QRコードのCanvas要素が見つかりませんでした。");
                }
                
                // ⭐ HTMLにQRコードのCanvasを表示（回転はCSSで適用）
                container.appendChild(qrCanvas.cloneNode()); // 結合用とは別に表示用をクローン
                container.insertAdjacentHTML('beforeend', '<p>ここに生成されたQRコードが表示されます（45度回転）。</p>');

                previewMessage.innerText = "画像を結合中...";

                // 3. 結合用の新しいCanvasを作成
                const combinedCanvas = document.createElement('canvas');
                // 結合後の画像のサイズを背景画像に合わせる（または調整）
                combinedCanvas.width = backgroundImage.width;
                combinedCanvas.height = backgroundImage.height;
                const ctx = combinedCanvas.getContext('2d');

                // 4. 背景画像を描画
                ctx.drawImage(backgroundImage, 0, 0, combinedCanvas.width, combinedCanvas.height);

                // 5. QRコードを描画（回転もCanvas APIで行う）
                // QRコードを中央に配置する例
                const qrSize = 200; // QRコードの生成サイズと合わせる
                const qrX = (combinedCanvas.width - qrSize) / 2;
                const qrY = (combinedCanvas.height - qrSize) / 2;

                ctx.save(); // 現在のCanvasの状態を保存
                // 回転の中心をQRコードの中心に設定
                ctx.translate(qrX + qrSize / 2, qrY + qrSize / 2);
                ctx.rotate(45 * Math.PI / 180); // 45度をラジアンに変換して回転
                ctx.drawImage(qrCanvas, -qrSize / 2, -qrSize / 2, qrSize, qrSize);
                ctx.restore(); // 保存した状態に戻す (回転や移動をリセット)


                // 6. 結合された画像をプレビュー表示
                const combinedDataUrl = combinedCanvas.toDataURL('image/png');
                combinedImageElement.src = combinedDataUrl;
                combinedImageElement.style.display = 'block';
                previewMessage.innerText = "結合されたQRコード画像です。";

                // 7. ダウンロードボタンを表示
                downloadButton.classList.remove('hidden');

            } catch (e) {
                container.innerHTML = `<p style="color: red;">エラー: ${e.message}</p>`;
                previewMessage.innerText = `結合エラー: ${e.message}`;
                console.error("QR生成または画像結合エラー:", e);
                combinedImagePreview.classList.remove('hidden'); // エラーメッセージ表示のため
                downloadButton.classList.add('hidden');
            }
        }

        // ダウンロードボタンのクリックイベントリスナー
        downloadButton.addEventListener('click', () => {
            const combinedCanvas = document.querySelector('#combined-image-preview canvas'); // 結合されたCanvasを探す
            if (!combinedCanvas) {
                alert('ダウンロードする結合済み画像が見つかりません。');
                return;
            }

            const imageDataUrl = combinedCanvas.toDataURL('image/png');

            const link = document.createElement('a');
            link.href = imageDataUrl;
            link.download = `combined_qrcode_${Date.now()}.png`; 
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
