<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QRコードリーダー（結果分離）</title>
  <style>
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 1px solid #ccc;
      min-height: 200px;
    }
    .controls {
      text-align: center;
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 0 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* 結果表示エリアのスタイル */
    #decoded-data {
        font-weight: bold;
        color: darkgreen;
        word-break: break-all; /* 長いURLなどに対応 */
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>QRコードを読み取る</h1>

<div class="controls">
    <button id="start-button">QRコード読み取り開始</button>
    <button id="cancel-button" disabled>キャンセルして停止</button>
</div>

<div id="reader" style="width: 300px; margin: 20px auto;"></div>

<p id="result">QRコードの内容がここに表示されます</p>

<p>読み取り結果:</p>
<p id="decoded-data">[読み取られていません]</p>


<script>
    // 画面要素を取得
    const resultElement = document.getElementById("result");
    const decodedDataElement = document.getElementById("decoded-data"); // ⭐ 新しく追加
    const startButton = document.getElementById("start-button");
    const cancelButton = document.getElementById("cancel-button");

    let html5QrCode = null;

    // 読み取り成功時の処理
    function onScanSuccess(decodedText, decodedResult) {
        html5QrCode.stop().then(() => {
            // ⭐ 状態メッセージは「成功しました」を表示
            resultElement.innerText = `読み取り成功！カメラを停止しました。`;
            // ⭐ 読み取ったデータ（decodedText）は新しい要素に表示
            decodedDataElement.innerText = decodedText; 
            
            console.log("QR Code scanning stopped.");
            resetUIButtons();
        }).catch(err => {
            resultElement.innerText = `読み取り成功、しかし停止エラー: ${err}`;
            resetUIButtons();
        });
    }

    // 読み取り失敗時やエラー時の処理（変更なし）
    function onScanFailure(error) {
      // ログ出力など
    }

    // UIの状態をリセット（初期状態に戻す）
    function resetUIButtons() {
        startButton.disabled = false;
        cancelButton.disabled = true;
        
        // QRコードの内容表示エリアをリセット
        if (resultElement.innerText !== "カメラが停止されました。") {
             resultElement.innerText = "QRコードの内容がここに表示されます";
        }
       
        // ⭐ QRコードの内容表示エリアを初期化
        if (!decodedDataElement.innerText.startsWith("読み取り成功！")) {
             decodedDataElement.innerText = "[読み取られていません]";
        }
        
        document.getElementById("reader").innerHTML = "";
        html5QrCode = new Html5Qrcode("reader"); 
    }

    // ************ 初期化 ************
    if (typeof Html5Qrcode !== 'undefined') {
        html5QrCode = new Html5Qrcode("reader"); 
    } else {
        resultElement.innerText = "ライブラリの読み込みに失敗しました。";
        startButton.disabled = true;
    }

    // ************ イベントリスナー ************

    // 読み取り開始ボタンの処理
    startButton.addEventListener('click', () => {
        startButton.disabled = true;
        cancelButton.disabled = false;
        // ⭐ 状態メッセージ
        resultElement.innerText = "カメラ起動中... QRコードをかざしてください。"; 
        // ⭐ データエリアは初期化
        decodedDataElement.innerText = "[スキャン中...]";

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            resultElement.innerText = `カメラ起動エラー: ${err}`;
            resetUIButtons();
            console.error(err);
        });
    });

    // キャンセルボタン（カメラ停止）の処理
    cancelButton.addEventListener('click', () => {
        if (html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                resultElement.innerText = "カメラが停止されました。";
                resetUIButtons();
            }).catch(err => {
                resultElement.innerText = `カメラ停止エラー: ${err}`;
                resetUIButtons();
            });
        } else {
            resetUIButtons();
        }
    });

    // ページロード時、最初の状態を設定
    resetUIButtons(); 

</script>
</body>
</html>
