<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QRコード生成・回転・画像保存</title>
    <style>
        #qrcode-container {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
        }

        #qrcode-container canvas, 
        #qrcode-container img {
            transform: rotate(45deg); 
            transform-origin: center center;
            margin: 50px; 
            transition: transform 0.3s ease-in-out; 
            /* QRコードが回転しても全体が見えるように */
            max-width: calc(100% - 100px); /* 親要素の幅からマージン分を引く */
            height: auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        /* ダウンロードボタンのスタイル */
        #download-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #28a745; /* 緑色 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* 最初は非表示 */
        }
        #download-button:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <h1>文字列をQRコードに変換・回転・画像保存</h1>

    <div class="input-group">
        <label for="text-input">変換したい文字列を入力してください:</label><br>
        <input type="text" id="text-input" value="Hello, Gemini!" style="width: 80%; padding: 8px;">
    </div>
    
    <button onclick="generateAndRotateQr()">QRコードを生成・回転</button>

    <div id="qrcode-container">
        <p>「QRコードを生成・回転」ボタンを押してください。</p>
    </div>

    <button id="download-button" class="hidden">QRコード画像を保存 (PNG)</button>

    <script>
        // DOM要素の取得
        const container = document.getElementById('qrcode-container');
        const inputTextElement = document.getElementById('text-input');
        const downloadButton = document.getElementById('download-button'); // ⭐ ダウンロードボタンを取得

        function generateAndRotateQr() {
            const inputText = inputTextElement.value;

            // 既存のQRコードとメッセージをクリア
            container.innerHTML = '';
            // ダウンロードボタンも非表示に戻す
            downloadButton.classList.add('hidden'); 
            
            if (!inputText) {
                container.innerHTML = '<p>文字列を入力してください。</p>';
                return;
            }

            try {
                // qrcode.jsを使ってQRコードを生成
                // 生成されたキャンバスは #qrcode-container の子要素として追加される
                new QrCode(container, {
                    text: inputText,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QrCode.CorrectLevel.H
                });
                
                container.insertAdjacentHTML('beforeend', '<p>QRコードを45度回転させて表示しています。</p>');
                
                // ⭐ QRコードが正常に生成されたらダウンロードボタンを表示
                downloadButton.classList.remove('hidden');

            } catch (e) {
                container.innerHTML = `<p style="color: red;">QRコード生成エラー: ${e.message}</p>`;
                // エラー時はダウンロードボタンを非表示のまま
                downloadButton.classList.add('hidden');
            }
        }

        // ⭐ ダウンロードボタンのクリックイベントリスナー
        downloadButton.addEventListener('click', () => {
            // qrcode.jsが生成したcanvas要素を探す
            const canvas = container.querySelector('canvas');

            if (canvas) {
                // canvasの内容をPNG形式のデータURIとして取得
                const imageDataUrl = canvas.toDataURL('image/png');

                // ダウンロード用の仮想リンクを作成
                const link = document.createElement('a');
                link.href = imageDataUrl;
                // ダウンロードされるファイル名を指定
                link.download = `qrcode_${Date.now()}.png`; 
                
                // リンクを一時的にDOMに追加してクリックし、すぐに削除する
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } else {
                alert('ダウンロードするQRコードが見つかりません。');
            }
        });
    </script>
</body>
</html>
